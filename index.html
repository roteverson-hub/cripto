<script>
  // 🔹 Endpoints
  const CHALLENGE_URL = "/api/challenge";
  const LOGIN_URL = "/api/login";
  const REGISTER_URL = "/api/register";
  const SUBMIT_URL = "/api/submit";
  const RANKING_URL = "/api/ranking";

  let originalWords = [];
  let startTime = null;

  // =========================
  // 🔹 Mensagem de bloqueio diário
  // =========================
  function showDailyBlockMessage() {
    const resultMsg = document.getElementById("result");
    resultMsg.textContent = "⚠️ Você já completou o desafio de hoje. Volte amanhã!";
    resultMsg.style.color = "#FF5252";
    document.getElementById('loadChallenge').style.display = "none";
    document.getElementById('submitAnswers').style.display = "none";
  }

  // =========================
  // 🔹 Persistência de Login
  // =========================
  async function checkLogin() {
    const user = localStorage.getItem("user");
    if (user) {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("register-section").style.display = "none";
      document.getElementById("game-section").style.display = "block";
      document.getElementById("welcome").textContent = `👋 Bem-vindo, ${user}!`;
      document.getElementById("logout").style.display = "block";
      loadRanking();

      // Verifica se usuário já completou hoje
      try {
        const res = await fetch(LOGIN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user, password: "" }) // password vazio apenas para check
        });
        const data = await res.json();
        if (data.alreadyCompletedToday) showDailyBlockMessage();
      } catch(err) {
        console.error("Erro ao verificar desafio diário:", err);
      }
    }
  }
  checkLogin();

  document.getElementById("logout").addEventListener("click", () => {
    localStorage.removeItem("user");
    location.reload();
  });

  // =========================
  // 🔹 Registro
  // =========================
  document.getElementById("btnRegister").addEventListener("click", async () => {
    const username = document.getElementById("register-username").value;
    const password = document.getElementById("register-password").value;
    try {
      const res = await fetch(REGISTER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      document.getElementById("registerMsg").textContent = data.message;
      if (data.success) {
        document.getElementById("register-section").style.display = "none";
        document.getElementById("login-section").style.display = "block";
      }
    } catch (err) {
      document.getElementById("registerMsg").textContent = "Erro ao registrar.";
    }
  });

  // =========================
  // 🔹 Login
  // =========================
  document.getElementById("btnLogin").addEventListener("click", async () => {
    const username = document.getElementById("login-username").value;
    const password = document.getElementById("login-password").value;
    try {
      const res = await fetch(LOGIN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      document.getElementById("loginMsg").textContent = data.message;
      if (data.success) {
        localStorage.setItem("user", username);
        document.getElementById("login-section").style.display = "none";
        document.getElementById("game-section").style.display = "block";
        document.getElementById("welcome").textContent = `👋 Bem-vindo, ${username}!`;
        document.getElementById("logout").style.display = "block";
        loadRanking();

        if (data.alreadyCompletedToday) {
          showDailyBlockMessage();
        }
      }
    } catch (err) {
      document.getElementById("loginMsg").textContent = "Erro ao logar.";
    }
  });

  // =========================
  // 🔹 Carregar Desafio
  // =========================
  document.getElementById('loadChallenge').addEventListener('click', async () => {
    try {
      const response = await fetch(CHALLENGE_URL);
      const data = await response.json();

      document.getElementById('theme').textContent = `Tema: ${data.theme}`;
      originalWords = data.original;

      const challengeDiv = document.getElementById('challenge');
      challengeDiv.innerHTML = '';
      data.words.forEach((word, index) => {
        const div = document.createElement('div');
        div.classList.add('challenge-word');
        div.innerHTML = `
          <p>${word}</p>
          <input type="text" id="input-${index}" placeholder="Digite a palavra correta">
          <span id="feedback-${index}"></span>
        `;
        challengeDiv.appendChild(div);
      });

      document.getElementById('instructions').style.display = 'none';
      document.getElementById('short-instructions').style.display = 'block';
      document.getElementById('loadChallenge').style.display = "none";
      document.getElementById('submitAnswers').style.display = "block";
      document.getElementById('result').textContent = "";
      startTime = Date.now();

    } catch (err) {
      console.error(err);
      alert("Erro ao carregar desafio do dia.");
    }
  });

  // =========================
  // 🔹 Submissão de respostas
  // =========================
  document.getElementById('submitAnswers').addEventListener('click', async () => {
    let correctCount = 0;
    originalWords.forEach((answer, index) => {
      const input = document.getElementById(`input-${index}`);
      const feedback = document.getElementById(`feedback-${index}`);
      if (input.value.trim().toUpperCase() === answer.toUpperCase()) {
        feedback.textContent = " ✅";
        feedback.className = "correct";
        correctCount++;
      } else {
        feedback.textContent = " ❌";
        feedback.className = "wrong";
      }
    });

    const resultMsg = document.getElementById("result");
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const points = correctCount;

    if (correctCount === originalWords.length) {
      resultMsg.textContent = "🎉 Parabéns! Você acertou todas!";
      resultMsg.style.color = "#4CAF50";
    } else {
      resultMsg.textContent = `Você acertou ${correctCount} de ${originalWords.length}.`;
      resultMsg.style.color = "#FFB300";
    }

    // Bloqueia se já completou (ou marca como completado)
    const username = localStorage.getItem("user");
    if (username) showDailyBlockMessage();

    try {
      await fetch(SUBMIT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username,
          challengeDate: new Date().toISOString().split("T")[0],
          points,
          attempts: originalWords.length,
          elapsed
        })
      });
      loadRanking();
    } catch (err) {
      console.error("Erro ao enviar resultado:", err);
    }
  });

  // =========================
  // 🔹 Carregar Ranking
  // =========================
  async function loadRanking() {
    try {
      const res = await fetch(RANKING_URL);
      const data = await res.json();
      document.getElementById("ranking-section").style.display = "flex";

      const dailyBody = document.querySelector("#daily-ranking tbody");
      dailyBody.innerHTML = "";
      (data.dailyTop || []).forEach((row, idx) => {
        dailyBody.innerHTML += `<tr>
          <td>${idx+1}</td><td>${row.username}</td><td>${row.points}</td>
        </tr>`;
      });

      const globalBody = document.querySelector("#global-ranking tbody");
      globalBody.innerHTML = "";
      (data.overallTotal || []).forEach((row, idx) => {
        globalBody.innerHTML += `<tr>
          <td>${idx+1}</td><td>${row.username}</td><td>${row.totalPoints}</td>
        </tr>`;
      });
    } catch (err) {
      console.error("Erro ao carregar ranking:", err);
    }
  }
</script>
