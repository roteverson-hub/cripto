<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Cripto3 - Desafio Di√°rio</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container" id="appContainer">

    <!-- üîπ Tela de Login -->
    <div id="login-section">
      <h1>Login</h1>
      <input type="text" id="login-username" placeholder="Usu√°rio" />
      <input type="password" id="login-password" placeholder="Senha" />
      <button class="btn" id="btnLogin">Entrar</button>
      <p>Ainda n√£o tem conta? <a href="#" id="goRegister">Registrar</a></p>
      <p id="loginMsg" class="result-message"></p>
    </div>

    <!-- üîπ Tela de Registro -->
    <div id="register-section" style="display:none;">
      <h1>Registrar</h1>
      <input type="text" id="register-username" placeholder="Usu√°rio" />
      <input type="password" id="register-password" placeholder="Senha" />
      <button class="btn" id="btnRegister">Criar Conta</button>
      <p>J√° tem conta? <a href="#" id="goLogin">Login</a></p>
      <p id="registerMsg" class="result-message"></p>
    </div>

    <!-- üîπ Tela do Jogo -->
    <div id="game-section" style="display:none;">
      <h1>CRIPTO3 ‚Äì Desafio Di√°rio</h1>
      <p id="welcome"></p>

      <!-- aviso de j√° jogou (banner no topo) -->
      <div id="alreadyPlayedMsg" class="already-played-msg" style="display:none;">
        ‚ö†Ô∏è Voc√™ j√° completou o desafio de hoje. Volte amanh√£.
      </div>

      <!-- üîπ Instru√ß√µes do jogo (mostra antes do desafio) -->
      <div id="instructions" class="game-instructions">
        <p>
          Todo dia liberamos um novo tema com <strong>3 palavras criptografadas</strong>.<br />
          Voc√™ precisa decifr√°-las digitando as respostas.<br />
          Quanto menos tentativas e mais r√°pido concluir, <strong>maior a sua pontua√ß√£o</strong>.
        </p>
        <p>
          <em>Exemplo:</em> <strong>"LUA" ‚Üí "QZE"</strong>. As 3 palavras usam a mesma substitui√ß√£o de letras.
        </p>
      </div>

      <p id="theme" class="theme-text"></p>

      <!-- üîπ Instru√ß√£o curta (s√≥ aparece depois que o desafio √© carregado) -->
      <p id="short-instructions" class="short-instructions" style="display:none;">
        Insira abaixo as 3 palavras corretas descriptografadas.
      </p>

      <div id="challenge" class="challenge-container"></div>
      <button id="loadChallenge" class="btn">Carregar Desafio do Dia</button>
      <button id="submitAnswers" class="btn" style="display: none;">Enviar Respostas</button>
      <p id="result" class="result-message"></p>
      <button id="logout" class="btn btn-danger" style="display:none;">Sair</button>

      <!-- üîπ Rankings lado a lado -->
      <div id="ranking-section" class="ranking-flex" style="margin-top:30px; display:none;">
        <div class="ranking-block">
          <h2>üèÜ Di√°rio</h2>
          <table id="daily-ranking" class="ranking-table">
            <thead>
              <tr><th>#</th><th>Usu√°rio</th><th>Pontos</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ranking-block">
          <h2>üåç Global</h2>
          <table id="global-ranking" class="ranking-table">
            <thead>
              <tr><th>#</th><th>Usu√°rio</th><th>Pontos</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Endpoints
    const CHALLENGE_URL = "/api/challenge";
    const LOGIN_URL = "/api/login";
    const REGISTER_URL = "/api/register";
    const SUBMIT_URL = "/api/submit";
    const RANKING_URL = "/api/ranking";

    let originalWords = [];
    let startTime = null;

    // Helpers UI (mantive suas fun√ß√µes)
    function showSection(id, visible) {
      document.getElementById(id).style.display = visible ? "block" : "none";
    }
    function showGameUI(user) {
      showSection("login-section", false);
      showSection("register-section", false);
      showSection("game-section", true);
      document.getElementById("welcome").textContent = `üëã Bem-vindo, ${user}!`;
      document.getElementById("logout").style.display = "block";
      loadRanking();
    }

    function showDailyBlockForUser(username) {
      const el = document.getElementById("alreadyPlayedMsg");
      if (el) {
        el.style.display = "block";
        el.textContent = "‚ö†Ô∏è Voc√™ j√° completou o desafio de hoje. Volte amanh√£.";
      }
      document.getElementById("short-instructions").style.display = "none";
      document.getElementById("loadChallenge").style.display = "none";
      document.getElementById("submitAnswers").style.display = "none";
      const resultMsg = document.getElementById("result");
      resultMsg.textContent = "";
      resultMsg.classList.remove("win");
      document.querySelector(".container")?.classList.add("already-played");
    }

    function clearDailyBlockUI() {
      const el = document.getElementById("alreadyPlayedMsg");
      if (el) el.style.display = "none";
      const resultMsg = document.getElementById("result");
      resultMsg.classList.remove("daily-block");
      resultMsg.classList.remove("win");
      resultMsg.textContent = "";
      resultMsg.style.color = "";
      document.querySelector(".container")?.classList.remove("already-played");
    }

    function showWinMessage() {
      const el = document.getElementById("alreadyPlayedMsg");
      if (el) el.style.display = "none";

      const resultMsg = document.getElementById("result");
      resultMsg.classList.remove("daily-block");
      resultMsg.classList.add("win");
      resultMsg.textContent = "Parab√©ns, voc√™ completou o desafio de hoje. Volte amanh√£ para solucionar mais um.";

      document.getElementById("loadChallenge").style.display = "none";
      document.getElementById("submitAnswers").style.display = "none";
      document.getElementById("short-instructions").style.display = "none";
      document.querySelector(".container")?.classList.add("already-played");
    }

    function todayString() {
      return new Date().toISOString().split("T")[0];
    }

    function setPlayedLocalForUser(username) {
      if (!username) return;
      localStorage.setItem(`playedDate:${username}`, todayString());
    }

    function hasPlayedLocalForUser(username) {
      if (!username) return false;
      return localStorage.getItem(`playedDate:${username}`) === todayString();
    }

    // Apaga cookie simples do cliente
    function eraseCookie(name) {
      document.cookie = name + "=; Max-Age=0; path=/";
    }

    // =========================
    // Persist√™ncia / Sincroniza√ß√£o
    // =========================
    async function checkLogin() {
      try {
        const res = await fetch(LOGIN_URL);
        const data = await res.json().catch(() => ({}));

        if (data.logged && data.username) {
          if (!localStorage.getItem("user")) localStorage.setItem("user", data.username);

          showGameUI(data.username);

          if (hasPlayedLocalForUser(data.username)) {
            showDailyBlockForUser(data.username);
            return;
          }

          if (data.alreadyCompletedToday) {
            setPlayedLocalForUser(data.username);
            showDailyBlockForUser(data.username);
            return;
          }

          clearDailyBlockUI();
        } else {
          showSection("login-section", true);
        }
      } catch (err) {
        console.error("checkLogin error:", err);
        showSection("login-section", true);
      }
    }
    checkLogin();

    // Logout -> remove cookie e localStorage user (mant√©m playedDate)
    document.getElementById("logout").addEventListener("click", async () => {
      try {
        // tenta limpar cookie do servidor tamb√©m
        await fetch(LOGIN_URL, { method: "DELETE", credentials: "same-origin" });
      } catch (e) { /* ignore */ }

      eraseCookie("user");
      localStorage.removeItem("user");
      document.getElementById("challenge").innerHTML = "";
      document.getElementById("theme").textContent = "";
      clearDailyBlockUI();
      location.reload();
    });

    // Troca telas
    document.getElementById("goRegister").addEventListener("click", (e) => {
      e.preventDefault();
      showSection("login-section", false);
      showSection("register-section", true);
    });
    document.getElementById("goLogin").addEventListener("click", (e) => {
      e.preventDefault();
      showSection("register-section", false);
      showSection("login-section", true);
    });

    // =========================
    // Registro -> AUTOP LOGIN
    // =========================
    document.getElementById("btnRegister").addEventListener("click", async () => {
      const username = document.getElementById("register-username").value.trim();
      const password = document.getElementById("register-password").value;
      try {
        const res = await fetch(REGISTER_URL, {
          method: "POST",
          credentials: "same-origin",               // importante: permite que Set-Cookie do servidor seja guardado
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        document.getElementById("registerMsg").textContent = data.message || "";

        if (data.success) {
          // Auto-login no cliente
          localStorage.setItem("user", username);
          showGameUI(username);

          // se servidor diz que j√° completou, marcar local e bloquear; sen√£o liberar
          if (data.alreadyCompletedToday) {
            setPlayedLocalForUser(username);
            showDailyBlockForUser(username);
          } else {
            clearDailyBlockUI();
            document.getElementById("loadChallenge").style.display = "block";
          }

          // limpa inputs
          document.getElementById("register-username").value = "";
          document.getElementById("register-password").value = "";
        }
      } catch (err) {
        console.error("register error:", err);
        document.getElementById("registerMsg").textContent = "Erro ao registrar.";
      }
    });

    // =========================
    // Login (mantive credentials para cookie funcionar)
    // =========================
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value;
      try {
        const res = await fetch(LOGIN_URL, {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        document.getElementById("loginMsg").textContent = data.message || "";

        if (data.success) {
          localStorage.setItem("user", username);
          showGameUI(username);

          if (data.alreadyCompletedToday) {
            setPlayedLocalForUser(username);
            showDailyBlockForUser(username);
          } else {
            clearDailyBlockUI();
            document.getElementById("loadChallenge").style.display = "block";
          }
        }
      } catch (err) {
        console.error("login error:", err);
        document.getElementById("loginMsg").textContent = "Erro ao logar.";
      }
    });

    // (o restante do code: loadChallenge, submitAnswers, loadRanking, etc. ‚Äî mantive igual ao seu c√≥digo anterior)
    // ... (sua l√≥gica de carregar desafio / enviar respostas / ranking segue inalterada)

    // Para economizar espa√ßo no snippet aqui, mantive todo o comportamento pr√©-existente
    // (loadChallenge, submitAnswers, loadRanking) id√™ntico ao que voc√™ j√° tinha.
    // Se quiser, eu copio aqui tamb√©m na √≠ntegra ‚Äî mas preferi n√£o duplicar tudo novamente.

  </script>
</body>
</html>
