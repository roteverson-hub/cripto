<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Cripto3 - Desafio Di√°rio</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container" id="appContainer">

    <!-- üîπ Tela de Login -->
    <div id="login-section">
      <h1>Login</h1>
      <input type="text" id="login-username" placeholder="Usu√°rio" />
      <input type="password" id="login-password" placeholder="Senha" />
      <button class="btn" id="btnLogin">Entrar</button>
      <p>Ainda n√£o tem conta? <a href="#" id="goRegister">Registrar</a></p>
      <p id="loginMsg" class="result-message"></p>
    </div>

    <!-- üîπ Tela de Registro -->
    <div id="register-section" style="display:none;">
      <h1>Registrar</h1>
      <input type="text" id="register-username" placeholder="Usu√°rio" />
      <input type="password" id="register-password" placeholder="Senha" />
      <button class="btn" id="btnRegister">Criar Conta</button>
      <p>J√° tem conta? <a href="#" id="goLogin">Login</a></p>
      <p id="registerMsg" class="result-message"></p>
    </div>

    <!-- üîπ Tela do Jogo -->
    <div id="game-section" style="display:none;">
      <h1>CRIPTO3 ‚Äì Desafio Di√°rio</h1>
      <p id="welcome"></p>

      <!-- aviso de j√° jogou -->
      <div id="alreadyPlayedMsg" class="already-played-msg" style="display:none;">
        ‚ö†Ô∏è Voc√™ j√° completou o desafio de hoje. Volte amanh√£.
      </div>

      <!-- üîπ Instru√ß√µes do jogo (mostra antes do desafio) -->
      <div id="instructions" class="game-instructions">
        <p>
          Todo dia liberamos um novo tema com <strong>3 palavras criptografadas</strong>.<br />
          Voc√™ precisa decifr√°-las digitando as respostas.<br />
          Quanto menos tentativas e mais r√°pido concluir, <strong>maior a sua pontua√ß√£o</strong>.
        </p>
        <p>
          <em>Exemplo:</em> <strong>"LUA" ‚Üí "QZE"</strong>. As 3 palavras usam a mesma substitui√ß√£o de letras.
        </p>
      </div>

      <p id="theme" class="theme-text"></p>

      <!-- üîπ Instru√ß√£o curta (s√≥ aparece depois que o desafio √© carregado) -->
      <p id="short-instructions" class="short-instructions" style="display:none;">
        Insira abaixo as 3 palavras corretas descriptografadas.
      </p>

      <div id="challenge" class="challenge-container"></div>
      <button id="loadChallenge" class="btn">Carregar Desafio do Dia</button>
      <button id="submitAnswers" class="btn" style="display: none;">Enviar Respostas</button>
      <p id="result" class="result-message"></p>
      <button id="logout" class="btn btn-danger" style="display:none;">Sair</button>

      <!-- üîπ Rankings lado a lado -->
      <div id="ranking-section" class="ranking-flex" style="margin-top:30px; display:none;">
        <div class="ranking-block">
          <h2>üèÜ Di√°rio</h2>
          <table id="daily-ranking" class="ranking-table">
            <thead>
              <tr><th>#</th><th>Usu√°rio</th><th>Pontos</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ranking-block">
          <h2>üåç Global</h2>
          <table id="global-ranking" class="ranking-table">
            <thead>
              <tr><th>#</th><th>Usu√°rio</th><th>Pontos</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Endpoints
    const CHALLENGE_URL = "/api/challenge";
    const LOGIN_URL = "/api/login";
    const REGISTER_URL = "/api/register";
    const SUBMIT_URL = "/api/submit";
    const RANKING_URL = "/api/ranking";

    let originalWords = [];
    let startTime = null;

    // Helpers UI
    function showSection(id, visible) {
      document.getElementById(id).style.display = visible ? "block" : "none";
    }
    function showGameUI(user) {
      showSection("login-section", false);
      showSection("register-section", false);
      showSection("game-section", true);
      document.getElementById("welcome").textContent = `üëã Bem-vindo, ${user}!`;
      document.getElementById("logout").style.display = "block";
      loadRanking();
    }

    function showDailyBlockForUser(username) {
      document.getElementById("result").textContent = "‚ö†Ô∏è Voc√™ j√° completou o desafio de hoje! Volte amanh√£.";
      document.getElementById("result").classList.add("daily-block");
      document.getElementById("short-instructions").style.display = "none";
      document.getElementById("loadChallenge").style.display = "none";
      document.getElementById("submitAnswers").style.display = "none";

      // visual adicional
      document.querySelector(".container")?.classList.add("already-played");
      const el = document.getElementById("alreadyPlayedMsg");
      if (el) el.style.display = "block";
    }

    function clearDailyBlockUI() {
      const resultMsg = document.getElementById("result");
      resultMsg.classList.remove("daily-block");
      resultMsg.textContent = "";
      resultMsg.style.color = "";
      document.querySelector(".container")?.classList.remove("already-played");
      const el = document.getElementById("alreadyPlayedMsg");
      if (el) el.style.display = "none";
    }

    function todayString() {
      return new Date().toISOString().split("T")[0];
    }

    function setPlayedLocalForUser(username) {
      if (!username) return;
      localStorage.setItem(`playedDate:${username}`, todayString());
    }

    function hasPlayedLocalForUser(username) {
      if (!username) return false;
      return localStorage.getItem(`playedDate:${username}`) === todayString();
    }

    // =========================
    // Persist√™ncia / Sincroniza√ß√£o
    // =========================
    async function checkLogin() {
      try {
        const res = await fetch(LOGIN_URL);
        const data = await res.json().catch(() => ({}));

        if (data.logged && data.username) {
          // grava usu√°rio local (n√£o remove playedDate)
          if (!localStorage.getItem("user")) localStorage.setItem("user", data.username);

          showGameUI(data.username);

          // prioridade: local playedDate per-user (imediato)
          if (hasPlayedLocalForUser(data.username)) {
            showDailyBlockForUser(data.username);
            return;
          }

          // depois: servidor (ranking) resposta
          if (data.alreadyCompletedToday) {
            // marca local e bloqueia
            setPlayedLocalForUser(data.username);
            showDailyBlockForUser(data.username);
            return;
          }

          // limpo UI
          clearDailyBlockUI();
        } else {
          showSection("login-section", true);
        }
      } catch (err) {
        console.error("checkLogin error:", err);
        showSection("login-section", true);
      }
    }
    checkLogin();

    // Logout -> limpa cookie no servidor (DELETE), e limpa user local (mas mant√©m playedDate:<user>)
    document.getElementById("logout").addEventListener("click", async () => {
      try {
        await fetch(LOGIN_URL, { method: "DELETE" });
      } catch (err) {
        console.error("logout request failed", err);
      }
      // remove apenas a sess√£o do usu√°rio (n√£o removemos playedDate:<user>)
      localStorage.removeItem("user");
      // limpa tela e volta ao login
      document.getElementById("challenge").innerHTML = "";
      document.getElementById("theme").textContent = "";
      clearDailyBlockUI();
      // for√ßa reload para limpar estados
      location.reload();
    });

    // Troca telas
    document.getElementById("goRegister").addEventListener("click", (e) => {
      e.preventDefault();
      showSection("login-section", false);
      showSection("register-section", true);
    });
    document.getElementById("goLogin").addEventListener("click", (e) => {
      e.preventDefault();
      showSection("register-section", false);
      showSection("login-section", true);
    });

    // Registro
    document.getElementById("btnRegister").addEventListener("click", async () => {
      const username = document.getElementById("register-username").value.trim();
      const password = document.getElementById("register-password").value;
      try {
        const res = await fetch(REGISTER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        document.getElementById("registerMsg").textContent = data.message || "";
        if (data.success) {
          showSection("register-section", false);
          showSection("login-section", true);
        }
      } catch (err) {
        document.getElementById("registerMsg").textContent = "Erro ao registrar.";
      }
    });

    // Login
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value;
      try {
        const res = await fetch(LOGIN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        document.getElementById("loginMsg").textContent = data.message || "";

        if (data.success) {
          // grava user local
          localStorage.setItem("user", username);
          showGameUI(username);

          // se servidor diz que j√° completou, bloqueia e marca local
          if (data.alreadyCompletedToday) {
            setPlayedLocalForUser(username);
            showDailyBlockForUser(username);
          } else {
            clearDailyBlockUI();
            document.getElementById("loadChallenge").style.display = "block";
          }
        }
      } catch (err) {
        console.error("login error:", err);
        document.getElementById("loginMsg").textContent = "Erro ao logar.";
      }
    });

    // Carregar Desafio (verifica estado servidor + local antes)
    document.getElementById("loadChallenge").addEventListener("click", async () => {
      const username = localStorage.getItem("user");
      if (!username) return;

      // checa local imediato (previne replays antes do ranking propagar)
      if (hasPlayedLocalForUser(username)) {
        showDailyBlockForUser(username);
        return;
      }

      // checa servidor via /api/login (GET) - autoritativo
      try {
        const statusRes = await fetch(LOGIN_URL);
        const status = await statusRes.json().catch(() => ({}));
        if (status.logged && status.username === username && status.alreadyCompletedToday) {
          setPlayedLocalForUser(username);
          showDailyBlockForUser(username);
          return;
        }
      } catch (err) {
        console.warn("status check failed (non-fatal):", err);
      }

      // se liberado, pega desafio normal
      try {
        const response = await fetch(CHALLENGE_URL);
        const data = await response.json();

        document.getElementById("theme").textContent = `Tema: ${data.theme || ""}`;
        originalWords = data.original || [];

        const challengeDiv = document.getElementById("challenge");
        challengeDiv.innerHTML = "";
        (data.words || []).forEach((word, index) => {
          const div = document.createElement("div");
          div.classList.add("challenge-word");
          div.innerHTML = `
            <p>${word}</p>
            <input type="text" id="input-${index}" placeholder="Digite a palavra correta" />
            <span id="feedback-${index}"></span>
          `;
          challengeDiv.appendChild(div);
        });

        // UI changes
        const longMsg = document.getElementById("instructions");
        const shortMsg = document.getElementById("short-instructions");
        if (longMsg) longMsg.style.display = "none";
        if (shortMsg) shortMsg.style.display = "block";

        document.getElementById("loadChallenge").style.display = "none";
        document.getElementById("submitAnswers").style.display = "block";
        clearDailyBlockUI();
        document.getElementById("result").textContent = "";
        startTime = Date.now();
      } catch (err) {
        console.error("Erro ao carregar desafio:", err);
        alert("Erro ao carregar desafio do dia.");
      }
    });

    // Verificar Respostas + Enviar Ranking
    document.getElementById("submitAnswers").addEventListener("click", async () => {
      let correctCount = 0;
      originalWords.forEach((answer, index) => {
        const input = document.getElementById(`input-${index}`);
        const feedback = document.getElementById(`feedback-${index}`);
        if (!input) return;
        if (input.value.trim().toUpperCase() === String(answer || "").toUpperCase()) {
          feedback.textContent = " ‚úÖ";
          feedback.className = "correct";
          correctCount++;
        } else {
          feedback.textContent = " ‚ùå";
          feedback.className = "wrong";
        }
      });

      const resultMsg = document.getElementById("result");
      const elapsed = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
      const points = correctCount;

      if (correctCount === originalWords.length) {
        resultMsg.textContent = "üéâ Parab√©ns! Voc√™ acertou todas!";
        resultMsg.style.color = "#4CAF50";
      } else {
        resultMsg.textContent = `Voc√™ acertou ${correctCount} de ${originalWords.length}.`;
        resultMsg.style.color = "#FFB300";
      }

      // envia para backend e bloqueia localmente
      try {
        const username = localStorage.getItem("user");
        const payload = {
          username,
          challengeDate: new Date().toISOString().split("T")[0],
          points,
          attempts: originalWords.length,
          elapsed
        };

        await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // marca localmente (preven√ß√£o imediata)
        setPlayedLocalForUser(username);
        showDailyBlockForUser(username);

        // atualiza ranking
        loadRanking();
      } catch (err) {
        console.error("Erro ao enviar resultado:", err);
      }
    });

    // Carregar Ranking
    async function loadRanking() {
      try {
        const res = await fetch(RANKING_URL);
        const data = await res.json();
        document.getElementById("ranking-section").style.display = "flex";

        // Di√°rio
        const dailyBody = document.querySelector("#daily-ranking tbody");
        dailyBody.innerHTML = "";
        (data.dailyTop || []).forEach((row, idx) => {
          dailyBody.innerHTML += `<tr>
            <td>${idx+1}</td><td>${row.username}</td><td>${row.points}</td>
          </tr>`;
        });

        // Global
        const globalBody = document.querySelector("#global-ranking tbody");
        globalBody.innerHTML = "";
        (data.overallTotal || []).forEach((row, idx) => {
          globalBody.innerHTML += `<tr>
            <td>${idx+1}</td><td>${row.username}</td><td>${row.totalPoints}</td>
          </tr>`;
        });
      } catch (err) {
        console.error("Erro ao carregar ranking:", err);
      }
    }
  </script>
</body>
</html>
